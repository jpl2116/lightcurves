#### this shows off a few features of my program
####
####

import sqlite3
import create_database
import derive_features
import noisification
from time import time

## what columns for features in features table
features_file = "derived_features_list.txt" # where we define features

## setup the db
connection = sqlite3.connect('astronomy.db')
cursor = connection.cursor()
create_database.create_db(cursor,features_file=features_file,REMOVE_RECORDS=True)
connection.commit()


## ingest a bunch of curves
begin_time = time()
folder = "data/debosscher" # a folder with some curves we can ingest
create_database.ingest_many_xml(folder,cursor,connection,survey="debosscher",original_number=False,number_processors=2)
end_time = time()
end_time - begin_time

## ingest more curves
begin_time = time()
folder = "data/ASAS_test" # a folder with some curves we can ingest
create_database.ingest_many_xml(folder,cursor,connection,survey="test",original_number=False,number_processors=2)
end_time = time()
end_time - begin_time





## now we derive features (mostly Lomb Scargle) for all of the ingested sources
# get all source ids
sql_query = """SELECT source_id FROM sources"""
cursor.execute(sql_query)
db_info = cursor.fetchall()
j = []
for i in db_info:
	j.append(i[0])

# derive features with 2 processors
begin_time_2 = time() 
derive_features_par(j,cursor,connection,number_processors=2)
end_time_2 = time()

# output everything to R file
# get all source ids in features table
sql_cmd = """SELECT source_id FROM features"""
cursor.execute(sql_cmd)
db_info = cursor.fetchall()
source_ids = []
for i in db_info:
	source_ids.append(i[0])
print source_ids
        
# output the file
outputRfile(source_ids,cursor,'outputRtest.txt')
tfeOutput(source_ids,cursor,'tfe.txt')

















## print list of class and number in each class by survey type

## take a look at some of the ingested curves
sql_cmd = """SELECT source_id,original_source_id,noisification,classification,number_points,survey,date,xml_filename FROM sources LIMIT 10"""        
cursor.execute(sql_cmd)
db_info = cursor.fetchall()
db_info



## print a few measurements for a source
source_id = db_info[0][0]
sql_cmd = """SELECT time, flux, error FROM measurements WHERE source_id=""" + repr(source_id) + """ LIMIT 10"""
cursor.execute(sql_cmd)
db_info = cursor.fetchall()
db_info



## 
sql_cmd = """SELECT time, flux, error FROM measurements LIMIT 10"""
cursor.execute(sql_cmd)
db_info = cursor.fetchall()
db_info






## view derived features for a source (features are stored in the
## features table)
source_id = db_info[0][0]
sql_cmd = """PRAGMA table_info(features);"""
cursor.execute(sql_cmd)
db_info = cursor.fetchall()
db_info # display feature names
sql_cmd = """SELECT * FROM features WHERE source_id=""" + repr(source_id)
sql_cmd
cursor.execute(sql_cmd)
db_info = cursor.fetchall()
db_info # display feature values







## now we noisify all of the curves in the database by
## adding noise to flux measurements
sql_query = """SELECT source_id FROM sources"""
cursor.execute(sql_query)
db_info = cursor.fetchall()
for i in db_info:
	noisification.sigma_noisification(cursor,i[0])


## source_id != original_source_id indicates that the source is derived from a clean
## curve. here we check that there are in fact
## noisified curves in the data set
sql_query = """SELECT source_id,original_source_id FROM sources WHERE source_id != original_source_id"""
cursor.execute(sql_query)
db_info = cursor.fetchall()
print db_info



## now derive L-S features for all noisified sources
## this may take a while
sql_query = """SELECT source_id FROM sources WHERE source_id != original_source_id"""
cursor.execute(sql_query)
db_info = cursor.fetchall()
for i in db_info:
	derive_features.enter_features(i[0],cursor)
	




##
## test derive features
##

import derive_features
derive_features.derive_features_par('',cursor)
